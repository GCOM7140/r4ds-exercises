---
title: "Data Wrangling Exercises"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The following 6 questions are based on concepts covered in Chapters 12-13 in R4DS. 
The questions will center around the `flights` dataset from the `nycflights13`, 
the `who` dataset from the `tidyr` package, and a few small example datasets. 
Start by loading the `tidyverse` and `nycflights13` packages. The `tidyr` package 
is loaded by default when the tidyverse is loaded.

```{r load-packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(nycflights13)
```

It is highly recommended to run `?flights` and `?who` from the R console to first 
familiarize yourself with the datasets.

--- 

**Question 1**:
Why does spreading this tibble fail? How could you add a new column to fix the problem? 
Hint: You can create an indicator column to uniquely identify each observation using 
the row number like this: `mutate(obs = row_number())`

Two different ages for Phillip Woods; 

```{r Q1, error=TRUE}
people <- tribble(
  ~name,             ~key,    ~value,
  #-----------------|--------|------
  "Phillip Woods",   "age",       45,
  "Phillip Woods",   "height",   186,
  "Phillip Woods",   "age",       50,
  "Jessica Cordero", "age",       37,
  "Jessica Cordero", "height",   156
)

people <- people %>% 
  group_by(name, key) %>% 
  mutate(obs = row_number()) 

people %>% 
  spread(key, value)
```

*This question is [12.3.1.#3](http://r4ds.had.co.nz/tidy-data.html#exercises-22) and grows your understanding of how `spread()` behaves with non-unique rows [(link)](http://r4ds.had.co.nz/tidy-data.html#spreading).*

---

**Question 2**:
Do you need to spread or gather the tibble below to tidy it? What are the variables?

Gather; # of Pregnant

```{r Q2}
preg <- tribble(
  ~pregnant, ~male, ~female,
  "yes",     NA,    10,
  "no",      20,    12
)

preg %>% 
  gather('male', 'female', key = "gender", value = "# of pregnant")
```

*This question is [12.3.1.#4](http://r4ds.had.co.nz/tidy-data.html#exercises-22) and grows your understanding of what "gathering" a dataset means [(link)](http://r4ds.had.co.nz/tidy-data.html#gathering).*

---

**Question 3**:
Running the following code generates a warning message. What does this message 
mean? Provide two ways to incorporate all of the data.

In the second grouping, there should have been just three characters instead of four. so it dropped the last letter "g"

```{r Q3}
tibble(x = c("a,b,c", "d,e,f,g", "h,i,j")) %>% 
  separate(x, c("one", "two", "three", "four"))

tibble(x = c("a,b,c,d,e,f,g,h,i,j"), grouping = c("one", "two", "three")) %>%
  spread()
  
```

*This question is [12.4.3.#1](http://r4ds.had.co.nz/tidy-data.html#exercises-23) and grows your ability to separate (parse) a column [(link)](http://r4ds.had.co.nz/tidy-data.html#separate).*

---

**Question 4**:
Both `unite()` and `separate()` have a `remove` argument. What does it do? Why would 
you set it to FALSE?  
*This question is [12.4.3.#2](http://r4ds.had.co.nz/tidy-data.html#exercises-23) and grows your understanding of how arguments can be used for finer control when parsing a column [(link)](http://r4ds.had.co.nz/tidy-data.html#spreading-and-gathering).*

It deletes the old columns - so for unite, it will delete all the columns it uses to consolidate into one column & for separate, it will delete the original column. You'd want to set it to FALSE in order to keep prior data
---

**Question 5**:
Using the `who` dataset, find the total number of cases of TB each year for China, 
India, and Bangladesh, and plot the data over time. Do you notice anything surprising? 
Hint: First, run the code block below to generate a cleaned dataset and answer 
the question using that `clean_who` dataset.  

```{r Q5}
clean_who <- who %>%
  gather(code, value, new_sp_m014:newrel_f65, na.rm = TRUE) %>% 
  mutate(code = gsub("newrel", "new_rel", code)) %>%
  separate(code, c("new", "var", "sexage")) %>% 
  select(-new, -iso2, -iso3) %>% 
  separate(sexage, c("sex", "age"), sep = 1)

summary <- clean_who %>% 
  group_by(country, year) %>% 
  summarize(total_cases = sum(value)) %>% 
  filter(country %in% c('China', 'India', 'Bangladesh'))
  
  ggplot(summary, aes(x = year, y = total_cases, color = country)) +
    geom_line() +
    geom_point()


```

*This question is based on [12.6.1.#4](http://r4ds.had.co.nz/tidy-data.html#exercises-25) and grows your ability to create a full wrangling pipeline and generate results [(link)](http://r4ds.had.co.nz/tidy-data.html#case-study).*

---

**Question 6**:
What weather conditions make it more likely to see a departure delay? Hint: Your 
answer should follow these steps:

1. Join observations existing in both `flights` with `weather` based on `origin`, 
`year`, `month`, `day`, and `hour`
2. Bin `wind_gust` and find the average `dep_delay` for different levels of gusts
3. Create a plot

```{r Q6}
flights %>% 
  inner_join(weather, 
                    by = c("origin" = "origin",
                    "year" = "year",
                    "month" = "month",
                    "day" = "day",
                    "hour" = "hour")) %>%  
  
  mutate(wind_gust_binned = cut(wind_gust, breaks=seq(0, max(wind_gust,na.rm=T), 5)), 
         precip_binned = cut(precip, breaks=seq(0, max(precip,na.rm=T), .05))) %>%
  group_by(wind_gust_binned) %>%
  summarise(dep_delay = mean(dep_delay, na.rm = TRUE)) %>%
  ggplot(aes(x = wind_gust_binned, y = dep_delay)) +
    geom_col()

```


*This question is based on [13.4.6.#4](http://r4ds.had.co.nz/relational-data.html#exercises-28) and grows your ability to use an inner join before summarizing data [(link)](http://r4ds.had.co.nz/relational-data.html#inner-join).*
