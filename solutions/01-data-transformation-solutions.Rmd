---
title: "Data Transformation Solutions"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The following five questions are based on concepts covered in Chapters 4-6 in 
R4DS and can be answered using the `flights` dataset from the `nycflights13` 
package. Start by loading the `tidyverse` and `nycflights13` packages.

```{r load-packages, warning = FALSE, message = FALSE}
library(tidyverse)
library(nycflights13)
```

Run `?flights` in the console to familiarize yourself with the dataset.

--- 

**Question 1**:
The following questions ask you to find flights that meet certain criteria and 
then count them.

 - How many flights flew into LAX?
 - How many flights flew out of LAX?
 - How many flights are greater than or equal to 2000 miles?
 - How many flights were destined for airports in the Los Angeles area (LAX, 
 ONT, SNA, PSP, SBD, BUR, or LGB), but did not originate out of JFK?

**Hint:** For each question, filter the dataset, then count the number of rows 
using `nrow()`. A review of comparison operators is presented in [5.2.2][5.2.2]. 
For the fourth question, use the `%in%` operator as well as the exclamation mark 
(`!`), which means not.

These questions are based on [5.2.4#1][5.2.4 Exercises] and designed to 
strengthen your ability to use the `dplyr` verb [`filter()`][filter].

**Answers:**

```{r}
# How many flights flew into LAX?
flights %>% 
  filter(dest == 'LAX') %>% 
  nrow()
```

```{r}
# How many flights flew out of LAX?
flights %>% 
  filter(origin == 'LAX') %>% 
  nrow()
```

**Note:** This is a trick question. You can confirm the correct answer is zero 
by running `?flights`. The dataset description states: "On-time data for all 
flights that departed NYC (i.e. JFK, LGA or EWR)". 'LAX' is the airport code for 
Los Angeles International Airport, so zero flights in this dataset originated 
from LAX.

```{r}
# How many flights are greater than or equal to 2000 miles?
flights %>% 
  filter(distance >= 2000) %>% 
  nrow()
```

```{r}
# How many flights were destined for airports in the Los Angeles area (LAX, ONT, 
# SNA, PSP, SBD, BUR, or LGB), but did not originate out of JFK?
flights %>% 
  filter(
    dest %in% c("LAX", "ONT", "SNA", "PSP", "SBD", "BUR", "LGB"), 
    origin != "JFK"
  ) %>% 
  nrow()
```

---

**Question 2**:
How many flights were "ghost flights"? A "ghost flight" is defined as a flight 
that departed, but never arrived (i.e., has a missing `arr_time`).

This question is based on [5.2.4#3][5.2.4 Exercises] and designed to strengthen 
your understanding of how the `dplyr` verb [`filter()`][filter] treats `NA` 
values.

**Answer:**

```{r Q2}
flights %>% 
  filter(is.na(arr_time), !is.na(dep_time)) %>% 
  nrow()
```

---

**Question 3**: 
How does [`arrange()`][arrange] treat missing values? How could you sort all 
rows with a missing `arr_time` to the top of the dataset?

This question is based on [5.3.1#1][5.3.1 Exercises] and designed to strengthen
your understanding of how the `dplyr` verb [`arrange()`][arrange] treats `NA` 
values.

**Answer**:
With the [`arrange()`][arrange] function, all non-missing values get sorted in 
ascending or descending fashion; then rows with missing values get displayed. 

The following code brings missing values to the top, then sorts the observations 
in descending order:

```{r Q3}
flights %>% 
  arrange(desc(is.na(arr_time)), desc(arr_time))
```

**Note:** `is.na(arr_time)` converts `arr_time` into `TRUE/FALSE` values. When 
sorting `TRUE/FALSE` values in ascending order, `FALSE` gets listed first, so 
`is.na(arr_time)` needed to be sorted in descending order to rise the missing 
values to the top of the dataset.

---

**Question 4**:
What do you observe after running the code below? How does this behavior reflect 
how [`select()`][select] helpers deal with uppercase and lowercase matching by 
default? How can you change that default? 

```{r Q4, eval = FALSE}
select(flights, contains("TIME"))`
```

This question is based on [5.4.1#4][5.4.1 Exercises] and designed to strengthen 
your ability to use the `dplyr` verb [`select()`][select].

**Answer**:
The current code fails to select any column names because the `contains()` 
function is case-sensitive by default. You can set the `ignore.case` argument to 
`TRUE` to find any match of "TIME" regardless of the case, like this:

```{r Q4a, eval=FALSE}
select(flights, contains("TIME", ignore.case = TRUE))
```

---

**Question 5**:
For each destination greater than or equal to 2000 miles away, compute total 
minutes of departure delay. Then determine what proportion of 
total-departure-delay minutes each destination represents. What three 
destinations top the list? 

**Hint:** Use [`filter()`][filter] to find the destinations greater than or 
equal to 2000 miles away with positive `dep_delay` values, then 
[`group_by()`][summarize] `dest`, then [`summarize()`][summarize] to find total 
departure delay minutes by destination, then [`mutate()`][mutate] to find 
proportions, and finally [`arrange()`][arrange] to find the top three. 

This question is based on [5.7.1#4][5.7.1 Exercises] and designed to strengthen 
your ability to calculate [per-group proportions of totals][grouped mutates].

**Answer**:

```{r Q5}
flights %>%
  filter(distance >= 2000, dep_delay > 0) %>%
  group_by(dest) %>%
  summarize(dep_delay_mins = sum(dep_delay)) %>%
  mutate(dep_delay_pct_of_total = dep_delay_mins / sum(dep_delay_mins)) %>%
  arrange(-dep_delay_pct_of_total) %>% 
  head(3)
```

[5.2.2]: http://r4ds.had.co.nz/transform.html#logical-operators
[5.2.4 Exercises]: http://r4ds.had.co.nz/transform.html#exercises-7
[5.3.1 Exercises]: http://r4ds.had.co.nz/transform.html#exercises-8
[5.4.1 Exercises]: http://r4ds.had.co.nz/transform.html#exercises-9
[5.7.1 Exercises]: http://r4ds.had.co.nz/transform.html#exercises-12
[filter]: http://r4ds.had.co.nz/transform.html#filter-rows-with-filter
[arrange]: http://r4ds.had.co.nz/transform.html#arrange-rows-with-arrange
[select]: http://r4ds.had.co.nz/transform.html#select-columns-with-select
[mutate]: http://r4ds.had.co.nz/transform.html#add-new-variables-with-mutate
[grouped mutates]: http://r4ds.had.co.nz/transform.html#grouped-mutates-and-filters
[summarize]: http://r4ds.had.co.nz/transform.html#grouped-summaries-with-summarise
